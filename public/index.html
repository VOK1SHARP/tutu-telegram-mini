<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ТИ•ТИ - Чайная лавка</title>
    <meta name="description" content="Онлайн-заказ китайского чая в Telegram Mini App">
    
    <!-- Стили -->
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Telegram WebApp -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    
    <!-- Open Graph -->
    <meta property="og:title" content="ТИ•ТИ - Чайная лавка">
    <meta property="og:description" content="Заказывайте аутентичный китайский чай прямо в Telegram!">
    <meta property="og:image" content="https://cdn-icons-png.flaticon.com/512/3048/3048379.png">
    <meta property="og:url" content="https://tea-shop-tg.netlify.app">
    
    <!-- Скрипт инициализации -->
    <script>
        // Проверяем, запущено ли в Telegram
        function isTelegramWebApp() {
            return window.Telegram && window.Telegram.WebApp;
        }
        
        // Функция для отладки
        window.debugTelegram = function() {
            if (isTelegramWebApp()) {
                console.log('=== TELEGRAM WEBAPP DEBUG ===');
                console.log('Telegram WebApp доступен');
                console.log('Версия:', Telegram.WebApp.version);
                console.log('Платформа:', Telegram.WebApp.platform);
                console.log('Инициализация:', Telegram.WebApp.initData);
                console.log('Пользователь:', Telegram.WebApp.initDataUnsafe?.user);
                console.log('============================');
            } else {
                console.log('=== TELEGRAM WEBAPP DEBUG ===');
                console.log('Telegram WebApp НЕ доступен');
                console.log('Запущено в браузере');
                console.log('============================');
            }
        };
        
        // Отключение зума при двойном тапе
        document.addEventListener('dblclick', function(e) {
            e.preventDefault();
        }, { passive: false });
        
        // Предотвращение контекстного меню
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });
    </script>
</head>
<body>
    <!-- Индикатор синхронизации -->
    <div id="sync-indicator" class="sync-indicator" style="display: none;">
        <i class="fas fa-sync-alt fa-spin"></i> Синхронизация...
    </div>
    
    <!-- Основное приложение -->
    <div id="app">
        <!-- Контент загружается через JavaScript -->
    </div>
    
    <!-- Модальные окна -->
    <div id="cart-modal" class="modal"></div>
    <div id="product-modal" class="modal"></div>
    <div id="order-modal" class="modal"></div>
    <div id="profile-modal" class="modal"></div>
    <div id="catalog-modal" class="modal"></div>
    <div id="confirm-overlay" style="display: none;"></div>
    <div id="toast-container"></div>
    
    <!-- Загрузочный экран -->
    <div id="loader">
        <div class="loader-content">
            <div class="loader-spinner">
                <i class="fas fa-leaf fa-spin"></i>
            </div>
            <h2>ТИ•ТИ</h2>
            <p id="loader-text">Загружаем чайную лавку...</p>
            <p id="loader-status" style="font-size: 12px; opacity: 0.7; margin-top: 10px;"></p>
        </div>
    </div>

    <!-- JavaScript Modules -->
    <script src="modules/utils.js"></script>
    <script src="modules/ui.js"></script>
    <script src="modules/storage.js"></script>
    <script src="modules/catalog.js"></script>
    <script src="modules/cart.js"></script>
    <script src="modules/orders.js"></script>
    <script src="modules/profile.js"></script>
    <script src="app.js"></script>
    
    <!-- Инициализация приложения -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const loaderText = document.getElementById('loader-text');
            const loaderStatus = document.getElementById('loader-status');
            
            // Для отладки
            if (window.location.hash === '#debug') {
                window.debugTelegram();
            }
            
            if (isTelegramWebApp()) {
                loaderStatus.textContent = 'Определяем пользователя Telegram...';
                
                const tg = window.Telegram.WebApp;
                
                // Настройка Telegram WebApp
                try {
                    if (tg.expand) tg.expand();
                    if (tg.setHeaderColor) tg.setHeaderColor('#4CAF50');
                    if (tg.setBackgroundColor) tg.setBackgroundColor('#f5f7fa');
                    if (tg.enableClosingConfirmation) tg.enableClosingConfirmation();
                    
                    console.log('Telegram WebApp настроен');
                } catch (e) {
                    console.warn('Ошибка настройки Telegram:', e);
                }
                
                // Проверка данных пользователя
                setTimeout(() => {
                    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                        const user = tg.initDataUnsafe.user;
                        loaderStatus.textContent = `Привет, ${user.first_name || 'пользователь'}!`;
                    } else {
                        loaderStatus.textContent = 'Telegram WebApp загружен';
                    }
                }, 500);
            } else {
                loaderStatus.textContent = 'Запущено в браузере (режим гостя)';
            }
            
            // Автоматическое скрытие загрузчика через 5 секунд (на всякий случай)
            setTimeout(() => {
                const loader = document.getElementById('loader');
                if (loader && loader.style.display !== 'none') {
                    console.warn('Принудительное скрытие загрузчика');
                    loader.style.opacity = '0';
                    setTimeout(() => loader.style.display = 'none', 300);
                    
                    const app = document.getElementById('app');
                    if (app) app.style.display = 'block';
                }
            }, 5000);
        });
        
        // Обработка ошибок загрузки скриптов
        window.addEventListener('error', function(e) {
            console.error('Ошибка загрузки скрипта:', e);
            const loaderStatus = document.getElementById('loader-status');
            if (loaderStatus) {
                loaderStatus.innerHTML = 'Ошибка загрузки приложения<br><small>Проверьте консоль (F12)</small>';
                loaderStatus.style.color = '#f44336';
            }
        });
    </script>
    
    <!-- Google Analytics (опционально) -->
    <script>
        if (window.location.hostname !== 'localhost') {
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'UA-XXXXXXXXX-X'); // Замените на ваш ID
        }
    </script>
</body>
</html>
